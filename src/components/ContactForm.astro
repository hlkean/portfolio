---
export const prerender = false;

const siteKey = import.meta.env.CAPTCHA_KEY ?? process.env.CAPTCHA_KEY;
const { title } = Astro.props;
---
<script is:inline src="https://www.google.com/recaptcha/api.js"></script>
<form id="contact-form">
	{title && <p class="title">{title}</p>}
	<div class="flex-container">
		<div class="flex-item">
			<label for="name">Your name:</label>
			<input id="name" name="name" placeholder="Input your name" required />
		</div>
		<div class="flex-item">
			<label for="email">Your email address:</label>
			<input id="email" type="email" name="email" placeholder="Input your email" required />
		</div>
	</div>
	<label for="message">Your message:</label>
	<textarea id="message" name="message" placeholder="Input your message here" required></textarea>
	<button class="g-recaptcha" data-sitekey={siteKey} data-callback="onSubmit" data-action="submit" type="submit"> 
		Send message <i class="fa-solid fa-arrow-right"></i>
	</button>
</form>
	
<script is:inline>
	let isLoading = false;
	const form = document?.getElementById('contact-form');

	function onSubmit (token) {
		isLoading = true;
		console.log('captcha submit')
		fetch("/api/recaptcha", {
			method: "POST",
			body: JSON.stringify({ recaptcha: token })
		})
		.then((response) => response.json())
		.then((gResponse) => {
			if (gResponse.success) {
			console.log('success!!', gResponse)
			// form.dispatchEvent(new Event('submit'));
			form.requestSubmit();
			// Captcha verification was a success
			} else {
			console.log('womp!', gResponse);
			isLoading = false;
			// Captcha verification failed
			}
		})
	}

	function sendEmail ({email, message}) {
		console.log('send email');
		fetch("/api/send-email", {
			method: "POST",
			body: JSON.stringify({
				email: email,
				message: message,
			})
		}).then((response) => {
			response.json()
			console.log('response: ', response);
			isLoading = false;
		}).catch((error) => {
			console.log("error sending email: ", error);
			isLoading = false;
			throw(error);
		});
	}

	document?.getElementById('contact-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();
		console.log('submitted');
		try {
			const email = e.target?.email?.value;
			const message = e.target?.message.value;
			sendEmail({email, message});
		} catch (error) {
			console.log("error sending email: ", error);
		};
	});
</script>

<style>
	form {
		display: flex;
		flex-direction: column;
		padding: var(--spacing-50) var(--spacing-100);
	}
	input, textarea {
		display: block;
		margin-bottom: var(--spacing-100);
		width: 100%;
		box-sizing: border-box;
		border-radius: var(--spacing-50);
		padding: var(--spacing-50);
		border: 2px solid var(--color-primary);
	}
	textarea {
		vertical-align: top;
  		height: 7rem;
	}
	button {
		border-radius: var(--spacing-75);
		background-color: var(--color-primary);
		border: 2px solid var(--color-secondary);
		color: var(--color-neutral-primary);
		padding: var(--spacing-100);
		font-size: var(--spacing-100);
	}
	.title {
		text-align: center;
		font-family: var(--font-heading);
	}
	.flex-container {
		display: flex;
		gap: var(--spacing-100);

	}
	.flex-item {
		flex: 1;
	}
</style>